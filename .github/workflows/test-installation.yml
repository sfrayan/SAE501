name: Test Installation Scripts

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'scripts/**'
      - 'radius/**'
      - 'php-admin/**'
      - 'wazuh/**'
  pull_request:
    branches: [ main ]

jobs:
  bash-lint:
    name: Bash Scripts Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck
      
      - name: Lint Bash Scripts
        run: |
          echo "üîç V√©rification syntaxe scripts Bash..."
          for script in scripts/*.sh; do
            echo "Checking: $script"
            bash -n "$script"
            shellcheck "$script" || true
          done
          echo "‚úÖ Lint termin√©"

  validate-configs:
    name: Validate Configuration Files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Validate RADIUS Config
        run: |
          echo "üîç V√©rification fichiers RADIUS..."
          if [ -f radius/clients.conf ]; then
            echo "‚úÖ clients.conf trouv√©"
          else
            echo "‚ùå clients.conf MANQUANT"
            exit 1
          fi
          
          if [ -d radius/sql ]; then
            echo "‚úÖ R√©pertoire SQL trouv√©"
          else
            echo "‚ùå R√©pertoire SQL MANQUANT"
            exit 1
          fi
      
      - name: Validate PHP Files
        run: |
          # V√©rifier que php-admin n'est pas vide
          if [ -f php-admin/index.php ]; then
            echo "‚úÖ index.php trouv√©"
          else
            echo "‚ùå index.php MANQUANT"
            exit 1
          fi
          
          # V√©rifier les pages
          for page in dashboard list_users add_user audit system settings; do
            if [ -f php-admin/pages/${page}.php ]; then
              echo "‚úÖ ${page}.php trouv√©"
            else
              echo "‚ùå ${page}.php MANQUANT"
              exit 1
            fi
          done
      
      - name: Validate Wazuh Config
        run: |
          if [ -f wazuh/manager.conf ]; then
            echo "‚úÖ manager.conf trouv√©"
          else
            echo "‚ùå manager.conf MANQUANT"
            exit 1
          fi

  check-secrets:
    name: Check for Secrets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Scan for Secrets
        run: |
          echo "üîê Recherche de secrets dans le code..."
          
          # Patterns de mots de passe
          PATTERNS=(
            'password\s*=.*[A-Za-z0-9]{6,}'
            'secret\s*=.*[A-Za-z0-9]{6,}'
            'api_key\s*='
            'Authorization:\s*Bearer'
          )
          
          FOUND_SECRETS=0
          for pattern in "${PATTERNS[@]}"; do
            if grep -r -i -E "$pattern" . --exclude-dir=.git --exclude-dir=.github --exclude=*.md; then
              echo "‚ö†Ô∏è  Possible secret found matching pattern: $pattern"
              FOUND_SECRETS=1
            fi
          done
          
          if [ $FOUND_SECRETS -eq 1 ]; then
            echo "‚ùå Secrets potentiels d√©tect√©s"
            exit 1
          else
            echo "‚úÖ Aucun secret d√©tect√©"
          fi

  documentation-check:
    name: Check Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Verify Documentation Files
        run: |
          echo "üìö V√©rification documentation..."
          
          required_docs=(
            "README.md"
            "QUICKSTART.md"
            "README_FINAL.md"
            "MODIFICATIONS_EFFECTUEES.md"
            "docs/dossier-architecture.md"
            "docs/hardening-linux.md"
            "docs/journal-de-bord.md"
          )
          
          for doc in "${required_docs[@]}"; do
            if [ -f "$doc" ]; then
              echo "‚úÖ $doc trouv√©"
            else
              echo "‚ö†Ô∏è  $doc MANQUANT"
            fi
          done

  build-pages:
    name: Build GitHub Pages
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true
      
      - name: Build Jekyll
        run: |
          echo "üî® Construction site GitHub Pages..."
          # Les fichiers markdown seront convertis en HTML automatiquement
          echo "‚úÖ Site GitHub Pages pr√™t"

  report:
    name: Generate Report
    runs-on: ubuntu-latest
    if: always()
    needs: [bash-lint, validate-configs, check-secrets, documentation-check]
    steps:
      - name: Test Summary
        run: |
          echo "üìä R√âSUM√â DES TESTS"
          echo "=================="
          echo "‚úÖ Bash Lint: ${{ needs.bash-lint.result }}"
          echo "‚úÖ Config Validation: ${{ needs.validate-configs.result }}"
          echo "‚úÖ Secrets Check: ${{ needs.check-secrets.result }}"
          echo "‚úÖ Documentation: ${{ needs.documentation-check.result }}"
          echo ""
          echo "Statut global: ${{ job.status }}"
          
          if [ "${{ job.status }}" = "failure" ]; then
            echo "‚ùå Certains tests ont √©chou√©"
            exit 1
          else
            echo "‚úÖ Tous les tests r√©ussis!"
          fi
