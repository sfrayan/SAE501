# FreeRADIUS SQL Module Configuration for SAE501
# MySQL/MariaDB authentication and accounting

sql {
    driver = "rlm_sql_mysql"
    server = "localhost"
    port = 3306
    login = "radiususer"
    password = "PLACEHOLDER_PASSWORD"
    radius_db = "radius"
    
    # Connection pool settings
    pool {
        start = 5
        min = 3
        max = 32
        spare = 10
        idle_timeout = 300
    }
    
    query_timeout = 30
    connect_timeout = 3
    
    # Enable reading from SQL
    read_groups = yes
    read_profiles = yes
    read_clients = yes
    
    delete_stale_sessions = yes
    
    # Default user profile - leave empty if not using profiles
    default_user_profile = ""
    
    # SQL username attribute - for logging
    sql_user_name = ""
    
    # Queries for authentication
    authorize_check_query = "SELECT id, username, attribute, value, op FROM radcheck WHERE username = '%{SQL-User-Name}' ORDER BY id"
    authorize_reply_query = "SELECT id, username, attribute, value, op FROM radreply WHERE username = '%{SQL-User-Name}' ORDER BY id"
    
    # Group membership query (CRITICAL for group-based auth)
    groupmembership_query = "SELECT groupname FROM radusergroup WHERE username = '%{SQL-User-Name}' ORDER BY priority"
    
    # Group check query
    authorize_group_check_query = "SELECT id, groupname, attribute, value, op FROM radgroupcheck WHERE groupname = '%{Sql-Group}' ORDER BY id"
    
    # Group reply query  
    authorize_group_reply_query = "SELECT id, groupname, attribute, value, op FROM radgroupreply WHERE groupname = '%{Sql-Group}' ORDER BY id"
    
    # Client query for NAS devices
    client_query = "SELECT id, nasname, shortname, type, secret FROM nas"
    
    # Accounting queries
    accounting_onoff_query = ""
    
    accounting {
        reference = ".query"
        type {
            accounting-on {
                query = "UPDATE radacct SET acctstoptime=NOW() WHERE accttype='Start' AND nasipaddress='%{NAS-IP-Address}' AND acctstoptime IS NULL"
            }
            accounting-off {
                query = "UPDATE radacct SET acctstoptime=NOW() WHERE accttype='Start' AND nasipaddress='%{NAS-IP-Address}' AND acctstoptime IS NULL"
            }
            start {
                query = "INSERT INTO radacct (acctsessionid, acctuniqueid, username, nasipaddress, nasportid, nasporttype, acctstarttime, acctsessiontime, acctinputoctets, acctoutputoctets, acctterminatecause, acctauthentic, connectinfo_start, connectinfo_stop, framedipaddress, callingstationid, calledstationid, servicetype) VALUES ('%{Acct-Session-Id}', '%{Acct-Unique-Session-Id}', '%{SQL-User-Name}', '%{NAS-IP-Address}', '%{NAS-Port}', '%{NAS-Port-Type}', NOW(), '0', '0', '0', '', '%{Acct-Authentic}', '', '', '%{Framed-IP-Address}', '%{Calling-Station-Id}', '%{Called-Station-Id}', '%{Service-Type}')"
            }
            interim-update {
                query = "UPDATE radacct SET acctsessiontime='%{Acct-Session-Time}', acctinputoctets='%{Acct-Input-Octets}', acctoutputoctets='%{Acct-Output-Octets}' WHERE acctsessionid='%{Acct-Session-Id}' AND nasipaddress='%{NAS-IP-Address}'"
            }
            stop {
                query = "UPDATE radacct SET acctstoptime=NOW(), acctsessiontime='%{Acct-Session-Time}', acctinputoctets='%{Acct-Input-Octets}', acctoutputoctets='%{Acct-Output-Octets}', acctterminatecause='%{Acct-Terminate-Cause}', connectinfo_stop='%{Connect-Info}' WHERE acctsessionid='%{Acct-Session-Id}' AND nasipaddress='%{NAS-IP-Address}'"
            }
        }
    }
    
    # Post-auth queries for logging
    post-auth {
        query = "INSERT INTO radpostauth (username, pass, reply, authdate) VALUES ('%{User-Name}', '%{User-Password}', '%{reply:Packet-Type}', NOW())"
    }
    
    # Safe characters for escaping
    safe_characters = "@abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789.-_: /"
    auto_escape = no
}
