# üîß Correction de bogue - FreeRADIUS Configuration
**Date**: 25 janvier 2026
**Probl√®me**: Installation √©chouait √† cause d'erreurs de configuration FreeRADIUS

## üìã Probl√®mes identifi√©s

### 1. **sql.conf contient des queries personnalis√©es incompatibles**
   - Les queries `authorize_check_query` et `authorize_reply_query` causaient des erreurs
   - Ces queries n'√©taient pas n√©cessaires pour fonctionner
   - Le module SQL fonctionne sans ces queries personnalis√©es

### 2. **install_radius.sh ne montre pas les erreurs r√©elles**
   - Le test de configuration `freeradius -C` √©tait silencieux en cas d'erreur
   - Les vraies erreurs n'√©taient pas affich√©es
   - L'installation s'arr√™tait sans explication claire

### 3. **Absence de diagnostic rapide**
   - Aucun script pour r√©parer rapidement les probl√®mes
   - Les utilisateurs devaient chercher manuellement les erreurs

## ‚úÖ Corrections appliqu√©es

### 1. **config/sql.conf** - SIMPLIFI√â
```diff
- authorize_check_query = "SELECT id, username, attribute, value, op FROM radcheck WHERE username = '%{SQL-User-Name}' ORDER BY id"
- authorize_reply_query = "SELECT id, username, attribute, value, op FROM radreply WHERE username = '%{SQL-User-Name}' ORDER BY id"
- client_query = "SELECT id, nasname, shortname, type, secret FROM nas"
+ # Removed - FreeRADIUS uses default queries instead
```

**Raison**: FreeRADIUS 3.0 fournit des queries par d√©faut qui fonctionnent sans surcharge.

### 2. **scripts/install_radius.sh** - AM√âLIOR√â
```bash
# Avant
if /usr/sbin/freeradius -C > /dev/null 2>&1; then
    log_message "SUCCESS" "Configuration RADIUS valide"
else
    log_message "WARNING" "Test de configuration √©chou√©"
    /usr/sbin/freeradius -X 2>&1 | head -50
fi

# Apr√®s
TEST_OUTPUT=$(/usr/sbin/freeradius -C 2>&1) || true
if echo "$TEST_OUTPUT" | grep -q "Configuration appears to be OK"; then
    log_message "SUCCESS" "Configuration RADIUS valide"
else
    log_message "WARNING" "Analyse des erreurs..."
    echo "$TEST_OUTPUT" | tee -a "$LOG_FILE"  # Affiche TOUT
    # Continue l'installation - FreeRADIUS peut d√©marrer avec des avertissements
fi
```

**Am√©liorations**:
- Affiche le **v√©ritable message d'erreur**
- Continue l'installation m√™me avec des avertissements
- Teste l'activation r√©elle du service

### 3. **scripts/fix_radius_config.sh** - NOUVEAU

Script pour diagnostiquer et r√©parer rapidement les probl√®mes:

```bash
sudo bash /opt/SAE501/scripts/fix_radius_config.sh
```

V√©rifie:
- Modules en conflit
- Configuration EAP
- Configuration SQL
- D√©marrage du service

## üöÄ Comment utiliser les corrections

### Option 1: Installation fra√Æche (RECOMMAND√â)

```bash
# Mettre √† jour depuis GitHub
cd /opt/SAE501
git pull origin main

# Relancer l'installation
sudo bash scripts/install_all.sh
```

### Option 2: R√©paration d'une installation existante

```bash
# Mettre √† jour les fichiers de config
git pull origin main

# Ex√©cuter le script de r√©paration
sudo bash scripts/fix_radius_config.sh
```

### Option 3: Diagnostic manuel

```bash
# V√©rifier la configuration
sudo /usr/sbin/freeradius -C

# Voir les erreurs d√©taill√©es
sudo /usr/sbin/freeradius -X

# V√©rifier le statut
sudo systemctl status freeradius

# Voir les logs
sudo journalctl -u freeradius -n 20
```

## üìä Fichiers modifi√©s

| Fichier | Type | Description |
|---------|------|-------------|
| `config/sql.conf` | Update | Suppression des queries personnalis√©es incompatibles |
| `scripts/install_radius.sh` | Update | Meilleure gestion des erreurs et diagnostics |
| `scripts/fix_radius_config.sh` | New | Script de r√©paration rapide |
| `docs/BUGFIX_20260125.md` | New | Ce document |

## ‚úîÔ∏è Tests effectu√©s

- ‚úÖ Configuration FreeRADIUS valide
- ‚úÖ Module SQL fonctionne sans queries personnalis√©es
- ‚úÖ Module EAP-PEAP connect√© correctement
- ‚úÖ Service FreeRADIUS se lance sans erreurs
- ‚úÖ Connexion MySQL OK

## üîç Diagnostic des probl√®mes r√©siduels

Si vous rencontrez toujours des probl√®mes:

```bash
# Test complet des services
bash /opt/SAE501/scripts/test_installation.sh

# Voir l'erreur exacte
sudo /usr/sbin/freeradius -X 2>&1 | grep -i error

# V√©rifier la base de donn√©es
mysql -u radiususer -p -e "SELECT * FROM radcheck LIMIT 1;"
```

## üìù Notes de version

- **Version**: 2.0.1
- **Date**: 25 janvier 2026  
- **Commits**: 3 (sql.conf, install_radius.sh, fix_radius_config.sh)
- **Impact**: Corrige l'erreur d'installation FreeRADIUS
- **R√©tro-compatibilit√©**: Oui

## üéØ Prochaines √©tapes

Apr√®s ces corrections:

1. Relancer: `sudo bash scripts/install_all.sh`
2. V√©rifier: `bash scripts/test_installation.sh`
3. Tester: `bash scripts/test_security.sh`
4. V√©rifier les acc√®s: `bash scripts/show_credentials.sh`

---

**Questions?** Consultez:
- README.md (guide principal)
- INSTALLATION_INTEGRATION_GUIDE.md (d√©tails d'installation)
- docs/HARDENING_GUIDE.md (s√©curit√©)
